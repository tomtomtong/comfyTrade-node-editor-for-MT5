<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MT5 Node-Based Strategy Builder</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="app-container">
    <!-- Top Toolbar -->
    <div class="toolbar">
      <div class="toolbar-left">
        <h1>MT5 Strategy Builder</h1>
        <button id="connectBtn" class="btn btn-primary">Connect MT5</button>
        <button id="showLogBtn" class="btn btn-secondary">Show Log</button>
        <button id="showAIMemoryBtn" class="btn btn-secondary">üß† AI Memory</button>
        <button id="showTradeJournalBtn" class="btn btn-secondary">üìñ Trade Journal</button>
        <button id="toggleBottomPanelBtn" class="btn btn-secondary">üìä Positions</button>
      </div>
      <div class="toolbar-right">
        <button id="tradeBtn" class="btn btn-success">New Trade</button>
        <button id="settingsBtn" class="btn btn-secondary">‚öô Settings</button>
        <button id="runStrategyBtn" class="btn btn-success">‚ñ∂ Run Strategy</button>
        <button id="stopStrategyBtn" class="btn btn-danger" style="display: none;">‚èπ Stop Strategy</button>
        <button id="saveGraphBtn" class="btn btn-secondary">Save</button>
        <button id="loadGraphBtn" class="btn btn-secondary">Load</button>
        <button id="clearGraphBtn" class="btn btn-danger">Clear</button>
      </div>
    </div>

    <!-- Main Layout -->
    <div class="main-layout">
      <div class="top-section">
        <!-- Left Sidebar - Node Palette -->
        <div class="sidebar left-sidebar">
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 0 10px;">
            <h3>Node Library</h3>
            <button id="importPluginBtn" class="btn btn-small btn-secondary" title="Import Custom Node Plugin" style="font-size: 11px; padding: 4px 8px;">
              üì¶ Import
            </button>
          </div>
          <input type="file" id="pluginFileInput" accept=".js" style="display: none;">
          
          <div class="node-category">
            <h4>Triggers</h4>
            <button class="node-btn trigger-btn" data-type="trigger">‚ö° Trigger</button>
          </div>

          <div class="node-category">
            <h4>Data</h4>
            <button class="node-btn signal-btn" data-type="string-input">üìù String Input</button>
            <button class="node-btn signal-btn" data-type="string-output">üìÑ String Output</button>
            <button class="node-btn signal-btn" data-type="mt5-data">üìä MT5 Data</button>
            <button class="node-btn signal-btn" data-type="yfinance-data">üìä yFinance Data</button>
            <button class="node-btn signal-btn" data-type="alphavantage-data">üìà Alpha Vantage Data</button>
            <button class="node-btn signal-btn" data-type="firecrawl-node">üï∑Ô∏è Firecrawl Scraper</button>
          </div>

          <div class="node-category" data-category="ai">
            <h4>AI</h4>
            <button class="node-btn signal-btn" data-type="llm-node">ü§ñ LLM Node</button>
            <button class="node-btn signal-btn" data-type="python-script">üêç Python Script</button>
          </div>

          <div class="node-category">
            <h4>Signals</h4>
            <button class="node-btn signal-btn" data-type="twilio-alert">üì± Twilio Alert</button>
          </div>

          <div class="node-category">
            <h4>Indicators</h4>
            <button class="node-btn" data-type="indicator-ma">Moving Average</button>
            <button class="node-btn" data-type="indicator-rsi">RSI</button>
          </div>

          <div class="node-category">
            <h4>Logic</h4>
            <button class="node-btn" data-type="conditional-check">Conditional Check</button>
            <button class="node-btn" data-type="string-contains">üîç String Contains</button>
            <button class="node-btn" data-type="logic-and">AND Gate</button>
            <button class="node-btn" data-type="logic-or">OR Gate</button>
          </div>

          <div class="node-category">
            <h4>Trading</h4>
            <button class="node-btn" data-type="trade-signal">Open Position</button>
            <button class="node-btn" data-type="close-position">Close Position</button>
            <button class="node-btn" data-type="modify-position">Modify Position</button>
          </div>

          <div class="node-category">
            <h4>Control</h4>
            <button class="node-btn control-btn" data-type="end-strategy">üèÅ End Strategy</button>
          </div>
        </div>

        <!-- Center - Node Editor Canvas -->
        <div class="editor-container">
          <canvas id="nodeCanvas"></canvas>
          <div class="canvas-hint">
            Click nodes from the left panel to add them to the canvas<br>
            Connect trigger outputs to trigger inputs to create execution flows<br>
            Click on connection lines to disconnect, select a node and press Delete key to remove it<br>
            <strong>Pan:</strong> Space+Drag, Middle Mouse, or Right Mouse | <strong>Zoom:</strong> Mouse Wheel or Ctrl+Drag<br>
            <strong>Hotkeys:</strong> Ctrl+Shift+A (Toggle Auto-connect) | Ctrl+Z (Undo) | Delete (Remove node)<br>
            <span id="undoHint" class="undo-hint" style="display: none;">Press Ctrl+Z to undo last deletion</span><br>
            <span id="autoConnectHint" class="undo-hint" style="display: none;"></span>
          </div>
        </div>

        <!-- Right Sidebar - Properties & Info -->
        <div class="sidebar right-sidebar">
          <div class="resize-handle resize-handle-left"></div>
          <div class="properties-panel">
            <h3>Properties</h3>
            <div id="nodeProperties">
              <p class="no-selection">Select a node to edit properties</p>
            </div>
          </div>

          <!-- Overtrade Reminder Panel -->
          <div class="overtrade-reminder-panel" id="overtradeReminderPanel">
            <h3>Trade Monitor</h3>
            <div class="overtrade-status-display" id="overtradeStatusDisplay">
              <div class="overtrade-indicator" id="overtradeIndicator">
                <div class="indicator-icon" id="indicatorIcon">‚úÖ</div>
                <div class="indicator-text" id="indicatorText">Safe Trading</div>
              </div>
              <div class="trade-count-info">
                <div class="count-item">
                  <span class="count-label">Current Period:</span>
                  <span class="count-value" id="currentTradeCount">0</span>
                </div>
                <div class="count-item">
                  <span class="count-label">Limit:</span>
                  <span class="count-value" id="tradeLimit">5</span>
                </div>
                <div class="count-item">
                  <span class="count-label">Time Period:</span>
                  <span class="count-value" id="timePeriodDisplay">hour</span>
                </div>
                <div class="count-item">
                  <span class="count-label">Next Reset:</span>
                  <span class="count-value" id="nextResetTime">-</span>
                </div>
              </div>
              <div class="overtrade-message" id="overtradeMessage" style="display: none;">
                <div class="message-icon">‚ö†Ô∏è</div>
                <div class="message-text">
                  <strong>Overtrade Alert!</strong><br>
                  Consider reviewing your trading strategy.
                </div>
              </div>
            </div>
          </div>

          <div class="account-panel">
            <h3>Account Info</h3>
            <div class="info-grid">
              <div class="info-item">
                <span class="label">Balance:</span>
                <span id="balance">-</span>
              </div>
              <div class="info-item">
                <span class="label">Equity:</span>
                <span id="equity">-</span>
              </div>
              <div class="info-item">
                <span class="label">Profit:</span>
                <span id="profit" class="profit">-</span>
              </div>
            </div>
            <button id="refreshAccountBtn" class="btn btn-secondary btn-small">Refresh</button>
          </div>

          <div class="closed-positions-filter-panel">
            <h3>Closed Positions Filter</h3>
            <div class="filter-controls">
              <div class="form-group">
                <label>Show last:</label>
                <select id="closedPositionsDays">
                  <option value="0.04">1 hour</option>
                  <option value="1">1 day</option>
                  <option value="3">3 days</option>
                  <option value="7" selected>7 days</option>
                  <option value="14">14 days</option>
                  <option value="30">30 days</option>
                </select>
              </div>
              <button id="refreshClosedPositionsBtn" class="btn btn-secondary btn-small">Refresh</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Bottom Panel - Positions -->
      <div class="bottom-panel">
        <div class="resize-handle resize-handle-top"></div>
        <div class="positions-panel">
          <div class="positions-tabs">
            <button class="positions-tab-btn active" data-tab="open">Open Positions</button>
            <button class="positions-tab-btn" data-tab="closed">Closed Positions</button>
          </div>
          
          <div id="openPositionsTab" class="positions-tab active">
            <div id="positionsList" class="positions-list">
              <p class="no-data">No open positions</p>
            </div>
          </div>
          
          <div id="closedPositionsTab" class="positions-tab">
            <div id="closedPositionsList" class="positions-list">
              <p class="no-data">No closed positions</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Connection Modal -->
    <div id="connectionModal" class="modal">
      <div class="modal-content">
        <h2>Connect to MT5</h2>
        <div class="connection-info">
          <p>Connecting to MetaTrader 5...</p>
          <p class="connection-details">Server: localhost:8765 (Python Bridge)</p>
        </div>
        <div class="modal-buttons">
          <button id="confirmConnectBtn" class="btn btn-primary">Connect</button>
          <button id="cancelConnectBtn" class="btn btn-secondary">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Trade Modal -->
    <div id="tradeModal" class="modal">
      <div class="modal-content trade-modal">
        <h2>Execute Trade</h2>
        <div class="form-group">
          <label>Symbol:</label>
          <div id="symbolInputContainer"></div>
        </div>
        <div class="form-group" id="currentPriceGroup" style="display: none;">
          <label>Current Price:</label>
          <div class="current-price-display">
            <div class="price-info">
              <span class="price-label">Bid:</span>
              <span id="currentBid" class="price-value">-</span>
            </div>
            <div class="price-info">
              <span class="price-label">Ask:</span>
              <span id="currentAsk" class="price-value">-</span>
            </div>
            <div class="price-info">
              <span class="price-label">Spread:</span>
              <span id="currentSpread" class="price-value">-</span>
            </div>
            <div class="price-refresh">
              <button id="refreshPriceBtn" class="btn btn-small btn-secondary">Refresh</button>
              <span id="priceUpdateTime" class="price-time">-</span>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label>Order Type:</label>
          <select id="tradeType">
            <option value="BUY" selected>Buy</option>
            <option value="SELL">Sell</option>
          </select>
        </div>
        <div class="form-group">
          <label>Volume:</label>
          <input type="number" id="tradeVolume" step="0.01" min="0.01" value="0.1">
          <div id="volumeLossInfo" class="volume-loss-info" style="display: none;">
            <div class="loss-warning">
              <span class="warning-icon">‚ö†Ô∏è</span>
              <span class="loss-text">Potential loss if price drops 1%: <span id="potentialLoss">$0.00</span></span>
            </div>
          </div>
        </div>
        <div class="modal-buttons">
          <button id="confirmTradeBtn" class="btn btn-primary">Execute Trade</button>
          <button id="cancelTradeBtn" class="btn btn-secondary">Cancel</button>
        </div>
      </div>
    </div>

    <div id="messageBox" class="message-box"></div>

    <!-- Overtrade Popup Notification -->
    <div id="overtradePopup" class="overtrade-popup" style="display: none;">
      <div class="overtrade-popup-content">
        <div class="overtrade-popup-icon">üö®</div>
        <div class="overtrade-popup-text">
          <div class="overtrade-popup-title">üî• DANGER! OVERTRADE DETECTED! üî•</div>
          <div class="overtrade-popup-message" id="overtradePopupMessage">‚ö° STOP! Too many trades detected! ‚ö°</div>
        </div>
        <button class="overtrade-popup-close" id="overtradePopupClose">√ó</button>
      </div>
    </div>

    <!-- Log Modal -->
    <div id="logModal" class="modal">
      <div class="modal-content log-modal">
        <h2>Console Log</h2>
        <div class="log-controls">
          <button id="clearLogBtn" class="btn btn-secondary btn-small">Clear Log</button>
          <button id="copyLogBtn" class="btn btn-secondary btn-small">Copy Log</button>
        </div>
        <div id="logContent" class="log-content">
          <p class="no-log">No log entries yet. Try testing volume loss to see symbol info.</p>
        </div>
        <div class="modal-buttons">
          <button id="closeLogBtn" class="btn btn-primary">Close</button>
        </div>
      </div>
    </div>

    <!-- AI Memory Modal -->
    <div id="aiMemoryModal" class="modal">
      <div class="modal-content log-modal">
        <h2>üß† AI Memory</h2>
        <div class="log-controls">
          <input 
            type="text" 
            id="aiMemoryFilter" 
            placeholder="Filter by node name..." 
            style="flex: 1; padding: 6px; margin-right: 8px; background: #1e1e1e; border: 1px solid #444; border-radius: 4px; color: #e0e0e0; font-size: 12px;"
            oninput="filterAIMemory()"
          />
          <button id="refreshAIMemoryBtn" class="btn btn-secondary btn-small">üîÑ Refresh</button>
          <button id="clearAllAIMemoryBtn" class="btn btn-danger btn-small">Clear All</button>
        </div>
        <div id="aiMemoryContent" class="log-content">
          <p class="no-log">No LLM nodes found or no memory entries yet.</p>
        </div>
        <div class="modal-buttons">
          <button id="closeAIMemoryBtn" class="btn btn-primary">Close</button>
        </div>
      </div>
    </div>

    <!-- Trade Journal Modal -->
    <div id="tradeJournalModal" class="modal">
      <div class="modal-content log-modal" style="max-width: 90%; max-height: 90vh;">
        <h2>üìñ Trade Journal</h2>
        <div class="log-controls">
          <input 
            type="text" 
            id="tradeJournalFilter" 
            placeholder="Filter by symbol, ticket, or type..." 
            style="flex: 1; padding: 6px; margin-right: 8px; background: #1e1e1e; border: 1px solid #444; border-radius: 4px; color: #e0e0e0; font-size: 12px;"
            oninput="filterTradeJournal()"
          />
          <button id="refreshTradeJournalBtn" class="btn btn-secondary btn-small">üîÑ Refresh</button>
        </div>
        <div id="tradeJournalContent" class="log-content" style="overflow-y: auto; max-height: calc(90vh - 150px);">
          <p class="no-log">No trades with charts found yet. Charts will appear here after executing trades.</p>
        </div>
        <div class="modal-buttons">
          <button id="closeTradeJournalBtn" class="btn btn-primary">Close</button>
        </div>
      </div>
    </div>

    <!-- Backtest Modal -->
    <div id="backtestModal" class="modal">
      <div class="modal-content">
        <h2>Backtest Mode - Select Data Source</h2>
        <div class="import-tabs">
          <button class="tab-btn active" data-tab="mt5">From MT5</button>
          <button class="tab-btn" data-tab="csv">From CSV</button>
        </div>
        
        <!-- MT5 Import Tab -->
        <div id="mt5ImportTab" class="import-tab active">
          <div class="form-group">
            <label>Symbol:</label>
            <div id="historySymbolInput"></div>
          </div>
          <div class="form-group">
            <label>Timeframe:</label>
            <select id="historyTimeframe">
              <option value="M1">M1 (1 Minute)</option>
              <option value="M5">M5 (5 Minutes)</option>
              <option value="M15">M15 (15 Minutes)</option>
              <option value="M30">M30 (30 Minutes)</option>
              <option value="H1" selected>H1 (1 Hour)</option>
              <option value="H4">H4 (4 Hours)</option>
              <option value="D1">D1 (Daily)</option>
              <option value="W1">W1 (Weekly)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Start Date:</label>
            <input type="date" id="historyStartDate">
          </div>
          <div class="form-group">
            <label>End Date:</label>
            <input type="date" id="historyEndDate">
          </div>
          <div class="form-group">
            <label>Number of Bars (optional):</label>
            <input type="number" id="historyBars" placeholder="Leave empty to use date range" min="1">
          </div>
        </div>
        
        <!-- CSV Import Tab -->
        <div id="csvImportTab" class="import-tab">
          <div class="form-group">
            <label>Upload CSV File:</label>
            <input type="file" id="csvFileInput" accept=".csv">
            <p class="help-text">CSV format: Date,Time,Open,High,Low,Close,Volume</p>
          </div>
          <div class="form-group">
            <label>Symbol Name:</label>
            <input type="text" id="csvSymbol" placeholder="e.g., EURUSD">
          </div>
        </div>
        
        <div id="historyStatus" class="history-status"></div>
        
        <div class="modal-buttons">
          <button id="confirmImportBtn" class="btn btn-primary">Start Backtest</button>
          <button id="cancelImportBtn" class="btn btn-secondary">Cancel</button>
        </div>
      </div>
    </div>



    <!-- Overtrade Warning Modal -->
    <div id="overtradeWarningModal" class="modal">
      <div class="modal-content">
        <h2>‚ö†Ô∏è Overtrade Reminder</h2>
        <div class="overtrade-warning-content">
          <p>You have executed <strong id="warningTradeCount">5</strong> trades in the last <strong id="warningTimePeriod">hour</strong>.</p>
          <div class="warning-details">
            <div class="warning-item">
              <span>Current trade frequency:</span>
              <span id="warningFrequency">5 trades/hour</span>
            </div>
            <div class="warning-item">
              <span>Time period started:</span>
              <span id="warningPeriodStart">-</span>
            </div>
            <div class="warning-item">
              <span>Next reset:</span>
              <span id="warningNextReset">-</span>
            </div>
          </div>
          <div class="warning-message">
            <p>Consider reviewing your trading strategy to avoid overtrading. You can still proceed with this trade.</p>
          </div>
        </div>
        <div class="modal-buttons">
          <button id="proceedTradeBtn" class="btn btn-primary">Proceed with Trade</button>
          <button id="cancelTradeFromWarningBtn" class="btn btn-secondary">Cancel Trade</button>
          <button id="disableRemindersBtn" class="btn btn-warning btn-small">Disable Reminders</button>
        </div>
      </div>
    </div>

    <!-- Run Strategy Modal -->
    <div id="runStrategyModal" class="modal">
      <div class="modal-content">
        <h2>‚ñ∂ Run Strategy</h2>
        <div class="run-strategy-content">
          <p>Choose how to execute your strategy:</p>
          <div class="run-options">
            <div class="run-option">
              <input type="radio" id="runOnce" name="runOption" value="once" checked>
              <label for="runOnce">
                <strong>Run Once</strong><br>
                <small>Execute all triggers one time immediately</small>
              </label>
            </div>
            <div class="run-option">
              <input type="radio" id="runPeriodic" name="runOption" value="periodic">
              <label for="runPeriodic">
                <strong>Run Periodically</strong><br>
                <small>Execute triggers repeatedly at specified intervals</small>
              </label>
            </div>
          </div>
          <div id="periodicSettings" style="display: none; margin-top: 15px;">
            <div class="form-group">
              <label>Interval:</label>
              <input type="number" id="periodicInterval" min="1" value="60">
            </div>
            <div class="form-group">
              <label>Unit:</label>
              <select id="periodicUnit">
                <option value="seconds">Seconds</option>
                <option value="minutes">Minutes</option>
                <option value="hours">Hours</option>
              </select>
            </div>
          </div>
        </div>
        <div class="modal-buttons">
          <button id="confirmRunBtn" class="btn btn-success">Run Strategy</button>
          <button id="cancelRunBtn" class="btn btn-secondary">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Stop Strategy Modal -->
    <div id="stopStrategyModal" class="modal">
      <div class="modal-content">
        <h2>‚èπÔ∏è Stop Strategy</h2>
        <div class="stop-strategy-content">
          <p>Are you sure you want to stop the periodic strategy execution?</p>
          <p><small>This will stop all periodic triggers but keep any open positions.</small></p>
        </div>
        <div class="modal-buttons">
          <button id="confirmStopBtn" class="btn btn-danger">Stop Strategy</button>
          <button id="cancelStopBtn" class="btn btn-secondary">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Volume Loss Reminder Modal -->
    <div id="priceDropAlert" class="price-drop-alert" style="display: none;">
      <h3>
        <span class="alert-icon">‚ö†Ô∏è</span>
        Volume Loss Reminder
      </h3>
      <div class="alert-content">
        <p>If you execute this volume and price moves 1% against you:</p>
        <div class="alert-details">
          <div class="alert-detail-item">
            <span>Symbol:</span>
            <span id="alertSymbol">-</span>
          </div>
          <div class="alert-detail-item">
            <span>Volume:</span>
            <span id="alertVolume">-</span>
          </div>
          <div class="alert-detail-item">
            <span>Current Price:</span>
            <span id="alertEntryPrice">-</span>
          </div>
          <div class="alert-detail-item">
            <span>Price After 1% Drop:</span>
            <span id="alertCurrentPrice">-</span>
          </div>
          <div class="alert-detail-item">
            <span>Price Change:</span>
            <span id="alertPriceChange">-</span>
          </div>
          <div class="alert-detail-item">
            <span>Potential Loss:</span>
            <span id="alertCurrentLoss">-</span>
          </div>
        </div>
        
        <!-- MT5 Contract Information -->
        <div class="mt5-contract-info" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
          <h4 style="margin: 0 0 10px 0; color: #666; font-size: 14px;">MT5 Contract Details</h4>
          <div class="alert-details">
            <div class="alert-detail-item">
              <span>Tick Size:</span>
              <span id="alertTickSize">-</span>
            </div>
            <div class="alert-detail-item">
              <span>Pip Size:</span>
              <span id="alertPipSize">-</span>
            </div>
            <div class="alert-detail-item">
              <span>Tick Value:</span>
              <span id="alertTickValue">-</span>
            </div>
            <div class="alert-detail-item">
              <span>Pip Value:</span>
              <span id="alertPipValue">-</span>
            </div>
            <div class="alert-detail-item">
              <span>Contract Size:</span>
              <span id="alertContractSize">-</span>
            </div>
            <div class="alert-detail-item">
              <span>Ticks per Pip:</span>
              <span id="alertTicksPerPip">-</span>
            </div>
            <div class="alert-detail-item">
              <span>Price Change (Pips):</span>
              <span id="alertPriceChangePips">-</span>
            </div>
          </div>
        </div>
      </div>
      <div class="alert-actions">
        <button id="closeAlertBtn" class="btn btn-secondary">Close</button>
        <button id="modifyPositionBtn" class="btn btn-primary">Modify Position</button>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmationModal" class="modal">
    <div class="modal-content">
      <h2 id="confirmationTitle">Confirm Action</h2>
      <p id="confirmationMessage">Are you sure?</p>
      <div class="modal-buttons">
        <button id="confirmYesBtn" class="btn btn-primary">Yes</button>
        <button id="confirmNoBtn" class="btn btn-secondary">No</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal">
    <div class="modal-content settings-modal">
      <h2>Settings</h2>
      
      <!-- Settings Tabs -->
      <div class="settings-tabs">
        <button class="settings-tab-btn active" data-tab="general">General</button>

        <button class="settings-tab-btn" data-tab="overtradeControl">Overtrade Control</button>
        <button class="settings-tab-btn" data-tab="twilioAlerts">Notification</button>
        <button class="settings-tab-btn" data-tab="aiAnalysis">AI Analysis</button>
      </div>
      
      <!-- General Tab -->
      <div id="generalTab" class="settings-tab active">
        

        
        <div class="form-group simulator-section">
          <h3 style="margin-top: 20px; border-top: 1px solid #333; padding-top: 15px;">üéÆ Simulator Mode</h3>
          <div class="form-group">
            <label>Trading Mode:</label>
            <select id="settingsSimulatorMode">
              <option value="false">Real Trading (Live MT5)</option>
              <option value="true">Simulator Mode (Practice)</option>
            </select>
            <small>Simulator mode uses real MT5 data but stores positions locally without executing real trades</small>
          </div>
          
          <div id="simulatorStatus" class="simulator-status" style="display: none;">
            <div class="status-grid">
              <div class="status-item">
                <span class="label">Mode:</span>
                <span id="simModeStatus" class="simulator-badge">SIMULATOR</span>
              </div>
              <div class="status-item">
                <span class="label">Open Positions:</span>
                <span id="simPositionsCount">0</span>
              </div>
              <div class="status-item">
                <span class="label">Closed Positions:</span>
                <span id="simClosedCount">0</span>
              </div>
              <div class="status-item">
                <span class="label">Balance:</span>
                <span id="simBalance">$10,000.00</span>
              </div>
              <div class="status-item">
                <span class="label">Equity:</span>
                <span id="simEquity">$10,000.00</span>
              </div>
              <div class="status-item">
                <span class="label">Profit:</span>
                <span id="simProfit">$0.00</span>
              </div>
            </div>
            
            <div class="form-group" style="margin-top: 15px;">
              <label>Reset Simulator Balance:</label>
              <div style="display: flex; gap: 10px; align-items: center;">
                <input type="number" id="resetSimulatorBalance" value="10000" min="100" step="100" style="flex: 1;">
                <button id="resetSimulatorBtn" class="btn btn-danger">Reset Simulator</button>
              </div>
              <small>‚ö†Ô∏è This will close all simulated positions and reset to the specified balance</small>
            </div>
          </div>
        </div>
      </div>

      
      <!-- Overtrade Control Tab -->
      <div id="overtradeControlTab" class="settings-tab">
        <div class="form-group" style="background: #2a2a2a; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
          <label style="font-weight: bold; color: #4CAF50;">Mode Indicator:</label>
          <div id="overtradeModeIndicator" style="margin-top: 5px; font-size: 14px;">Current Mode: Real Trading</div>
          <small style="color: #888; display: block; margin-top: 5px;">Settings are automatically applied based on your current trading mode (Real Trading or Simulator). Each mode has separate trade limits and history.</small>
        </div>
        <div class="form-group">
          <label>Enable Overtrade Reminders:</label>
          <select id="settingsOvertradeEnabled">
            <option value="true">Enabled</option>
            <option value="false">Disabled</option>
          </select>
        </div>
        <div class="form-group">
          <label>Warning Threshold (trades per period):</label>
          <input type="number" id="settingsMaxTrades" min="1" value="5" placeholder="e.g., 5">
          <small>Show warning when this many trades are executed</small>
        </div>
        <div class="form-group">
          <label>Time Period:</label>
          <select id="settingsTimePeriod">
            <option value="minute">Per Minute</option>
            <option value="hour" selected>Per Hour</option>
            <option value="day">Per Day</option>
            <option value="week">Per Week</option>
          </select>
        </div>
        <div class="form-group">
          <label>Reminder Frequency:</label>
          <select id="settingsReminderFrequency">
            <option value="every">Every trade after threshold</option>
            <option value="first" selected>Only first time threshold is reached</option>
            <option value="periodic">Every 3 trades after threshold</option>
          </select>
        </div>
        <div class="form-group">
          <label>Apply reminders to:</label>
          <div class="checkbox-group">
            <label><input type="checkbox" id="settingsApplyToManual" checked> Manual Trades</label>
            <label><input type="checkbox" id="settingsApplyToStrategy" checked> Strategy Trades</label>
            <label><input type="checkbox" id="settingsApplyToNodes" checked> Node-based Trades</label>
          </div>
        </div>
        <div class="form-group">
          <label>Count these position types:</label>
          <div class="checkbox-group">
            <label><input type="checkbox" id="settingsApplyToOpenPositions" checked> Opening Positions</label>
            <label><input type="checkbox" id="settingsApplyToClosePositions"> Closing Positions</label>
          </div>
        </div>
        <div class="overtrade-status">
          <h3>Current Status</h3>
          <div class="status-grid">
            <div class="status-item">
              <span class="label">Trades in Current Period:</span>
              <span id="settingsCurrentTradeCount">0</span>
            </div>
            <div class="status-item">
              <span class="label">Until Warning Threshold:</span>
              <span id="settingsRemainingTrades">5</span>
            </div>
            <div class="status-item">
              <span class="label">Period Resets:</span>
              <span id="settingsNextReset">-</span>
            </div>
            <div class="status-item">
              <span class="label">Last Warning:</span>
              <span id="settingsLastWarning">Never</span>
            </div>
          </div>
        </div>
        <div class="overtrade-actions">
          <button id="settingsResetTradeCountBtn" class="btn btn-warning">Reset Count</button>
          <button id="settingsTestOvertradeBtn" class="btn btn-info">Test (Add 5 Trades)</button>
        </div>
        
        <div class="volume-control-section" style="margin-top: 30px; border-top: 1px solid #333; padding-top: 20px;">
          <h3>üìä Volume Controls</h3>
          <div class="form-group">
            <label>Enable Symbol Volume Limits:</label>
            <select id="settingsVolumeControlEnabled">
              <option value="false">Disabled</option>
              <option value="true">Enabled</option>
            </select>
            <small>Set default volume and maximum limit for specific symbols. When a symbol is selected, the volume field will auto-populate with the configured default volume.</small>
          </div>
          
          <div class="volume-status">
            <h3>Current Volume Limits (Default & Max)</h3>
            <div id="volumeLimitsList" class="volume-limits-display">
              <!-- Volume limits will be populated here -->
            </div>
          </div>
          
          <div class="volume-actions">
            <div class="volume-add-controls">
              <div id="volumeSymbolInputContainer" class="volume-symbol-container"></div>
              <input type="number" id="newVolumeLimit" placeholder="Default Volume (Max)" min="0.01" step="0.01" class="volume-limit-input">
              <button id="addVolumeLimitBtn" class="btn btn-primary">Add Volume</button>
            </div>
            

          </div>
        </div>
      </div>
      
      <!-- Notification Tab -->
      <div id="twilioAlertsTab" class="settings-tab">
        <div class="twilio-config-section">
          <h4>üîë Twilio Credentials</h4>
          <div class="twilio-grid">
            <div class="form-group">
              <label>Account SID:</label>
              <input type="text" id="settingsTwilioAccountSid" placeholder="ACxxxxxxxx...">
              <small>From Twilio Console</small>
            </div>
            <div class="form-group">
              <label>Auth Token:</label>
              <input type="password" id="settingsTwilioAuthToken" placeholder="Your token">
              <small>From Twilio Console</small>
            </div>
          </div>
          <div class="form-group">
            <label>From Number:</label>
            <input type="text" id="settingsTwilioFromNumber" placeholder="+1234567890">
            <small>Your Twilio phone number</small>
          </div>
        </div>
        
        <div class="notification-config-section">
          <h4>üì± Notification Settings</h4>
          <div class="twilio-grid">
            <div class="form-group">
              <label>Recipient Number:</label>
              <input type="text" id="settingsRecipientNumber" placeholder="+1987654321">
              <small>Your phone number</small>
            </div>
            <div class="form-group">
              <label>Method:</label>
              <select id="settingsNotificationMethod">
                <option value="sms">SMS</option>
                <option value="whatsapp">WhatsApp</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label>Alert Types:</label>
            <div class="checkbox-group twilio-checkbox-grid">
              <label><input type="checkbox" id="settingsAlertTakeProfit" checked> Take Profit</label>
              <label><input type="checkbox" id="settingsAlertStopLoss" checked> Stop Loss</label>
              <label><input type="checkbox" id="settingsAlertPositionOpened"> Position Opened</label>
              <label><input type="checkbox" id="settingsAlertPositionClosed"> Position Closed</label>
            </div>
          </div>
        </div>
        
        <!-- Telegram Configuration -->
        <div class="twilio-config-section">
          <h4>ü§ñ Telegram Bot Configuration</h4>
          <div class="twilio-grid">
            <div class="form-group">
              <label>Bot Token:</label>
              <input type="password" id="settingsTelegramBotToken" placeholder="123456789:ABCdefGHIjklMNOpqrsTUVwxyz">
              <small>From @BotFather on Telegram</small>
            </div>
            <div class="form-group">
              <label>Chat ID:</label>
              <input type="text" id="settingsTelegramChatId" placeholder="123456789">
              <small>Your Telegram chat ID</small>
            </div>
          </div>
        </div>
        
        <div class="twilio-test-section">
          <h4>üß™ Test</h4>
          <div class="form-group">
            <button id="testTwilioBtn" class="btn btn-info btn-small">Send Test Twilio</button>
            <button id="testTelegramBtn" class="btn btn-info btn-small">Send Test Telegram</button>
            <div id="twilioTestResult" class="test-result"></div>
            <div id="telegramTestResult" class="test-result"></div>
          </div>
        </div>
      </div>
      
      <!-- AI Analysis Tab -->
      <div id="aiAnalysisTab" class="settings-tab">
        <div class="twilio-config-section">
          <h4>üî• Firecrawl Configuration</h4>
          <div class="twilio-grid">
            <div class="form-group">
              <label>API Key:</label>
              <input type="password" id="settingsFirecrawlApiKey" placeholder="fc-xxxxxxxxxxxxxxxx">
              <small>Your Firecrawl API key</small>
            </div>
            <div class="form-group">
              <label>Enable Firecrawl:</label>
              <select id="settingsFirecrawlEnabled">
                <option value="false">Disabled</option>
                <option value="true">Enabled</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Base URL:</label>
            <input type="text" id="settingsFirecrawlBaseUrl" placeholder="https://api.firecrawl.dev" value="https://api.firecrawl.dev">
            <small>Firecrawl API endpoint (leave default unless using self-hosted)</small>
          </div>
        </div>
        
        <div class="notification-config-section">
          <h4>ü§ñ OpenRouter Configuration</h4>
          <div class="twilio-grid">
            <div class="form-group">
              <label>API Key:</label>
              <input type="password" id="settingsOpenRouterApiKey" placeholder="sk-or-v1-xxxxxxxxxxxxxxxx">
              <small>Your OpenRouter API key</small>
            </div>
            <div class="form-group">
              <label>Enable OpenRouter:</label>
              <select id="settingsOpenRouterEnabled">
                <option value="false">Disabled</option>
                <option value="true">Enabled</option>
              </select>
            </div>
          </div>
          <div class="twilio-grid">
            <div class="form-group">
              <label>Default Model:</label>
              <select id="settingsOpenRouterModel">
                <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet</option>
                <option value="openai/gpt-4o">GPT-4o</option>
                <option value="openai/gpt-4o-mini">GPT-4o Mini</option>
                <option value="google/gemini-pro-1.5">Gemini Pro 1.5</option>
                <option value="meta-llama/llama-3.1-8b-instruct">Llama 3.1 8B</option>
                <option value="meta-llama/llama-3.1-70b-instruct">Llama 3.1 70B</option>
              </select>
              <small>AI model for analysis</small>
            </div>
            <div class="form-group">
              <label>Base URL:</label>
              <input type="text" id="settingsOpenRouterBaseUrl" placeholder="https://openrouter.ai/api/v1" value="https://openrouter.ai/api/v1">
              <small>OpenRouter API endpoint</small>
            </div>
          </div>
          
          <div class="form-group">
            <label>AI Analysis Features:</label>
            <div class="checkbox-group twilio-checkbox-grid">
              <label><input type="checkbox" id="settingsAiMarketAnalysis" checked> Market Sentiment Analysis</label>
              <label><input type="checkbox" id="settingsAiNewsAnalysis" checked> News Impact Analysis</label>
              <label><input type="checkbox" id="settingsAiStrategyOptimization"> Strategy Optimization</label>
              <label><input type="checkbox" id="settingsAiRiskAssessment" checked> Risk Assessment</label>
            </div>
          </div>
        </div>
        
        <div class="notification-config-section">
          <h4>üìà Alpha Vantage Configuration</h4>
          <div class="twilio-grid">
            <div class="form-group">
              <label>API Key:</label>
              <input type="password" id="settingsAlphaVantageApiKey" placeholder="Your Alpha Vantage API key">
              <small>Your Alpha Vantage API key for market data</small>
            </div>
            <div class="form-group">
              <label>Enable Alpha Vantage:</label>
              <select id="settingsAlphaVantageEnabled">
                <option value="false">Disabled</option>
                <option value="true">Enabled</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Base URL:</label>
            <input type="text" id="settingsAlphaVantageBaseUrl" placeholder="https://www.alphavantage.co/query" value="https://www.alphavantage.co/query">
            <small>Alpha Vantage API endpoint</small>
          </div>
        </div>
        
        <div class="twilio-test-section">
          <h4>üß™ Test Configurations</h4>
          <div class="form-group">
            <button id="testFirecrawlBtn" class="btn btn-info btn-small">Test Firecrawl</button>
            <button id="testOpenRouterBtn" class="btn btn-info btn-small">Test OpenRouter</button>
            <button id="testAlphaVantageBtn" class="btn btn-info btn-small">Test Alpha Vantage</button>
            <div id="aiTestResult" class="test-result"></div>
          </div>
        </div>
      </div>
      
      <div class="modal-buttons">
        <input type="file" id="loadSettingsFileInput" accept=".json" style="display: none;">
        <button id="loadSettingsBtn" class="btn btn-info">üìÇ Load Settings</button>
        <button id="closeSettingsBtn" class="btn btn-secondary">Close</button>
        <button id="saveSettingsBtn" class="btn btn-primary">Save Settings</button>
      </div>
    </div>
  </div>

  <!-- Trade Confirmation Modal -->
  <div id="tradeConfirmationModal" class="modal">
    <div class="modal-content trade-confirmation-modal">
      <h2>üìä Confirm Trade Execution</h2>
      
      <div class="trade-confirmation-details">
        <div class="confirmation-item">
          <span class="label">Symbol:</span>
          <span id="confirmTradeSymbol" class="value">-</span>
        </div>
        <div class="confirmation-item">
          <span class="label">Action:</span>
          <span id="confirmTradeType" class="value trade-type">-</span>
        </div>
        <div class="confirmation-item">
          <span class="label">Volume:</span>
          <span id="confirmTradeVolume" class="value">-</span>
        </div>
        <div class="confirmation-item">
          <span class="label">Current Price:</span>
          <span id="confirmTradeCurrentPrice" class="value">Loading...</span>
        </div>
        <div class="confirmation-item">
          <span class="label">Stop Loss <span style="color: #f44336;">*</span>:</span>
          <input type="number" id="confirmTradeStopLoss" class="value confirmation-input" step="0.00001" placeholder="Enter stop loss" required>
        </div>
        <div class="confirmation-item">
          <span class="label">Take Profit <span style="color: #f44336;">*</span>:</span>
          <input type="number" id="confirmTradeTakeProfit" class="value confirmation-input" step="0.00001" placeholder="Enter take profit" required>
        </div>
      </div>
      
      <div class="confirmation-notice">
        <p>‚ö†Ô∏è Please review the trade details before confirming</p>
      </div>
      
      <!-- 6 Month Daily Chart -->
      <div class="chart-container-wrapper">
        <h3 style="margin-top: 20px; margin-bottom: 10px;">üìä 6-Month Daily Chart</h3>
        <div id="chartLoading" class="chart-loading" style="text-align: center; padding: 20px; color: #888;">
          Loading chart data...
        </div>
        <div id="chartError" class="chart-error" style="display: none; text-align: center; padding: 20px; color: #f44336;">
          Failed to load chart data
        </div>
        <canvas id="tradeChart" style="display: none; max-height: 400px;"></canvas>
      </div>
      
      <div class="modal-buttons">
        <button onclick="hideTradeConfirmationModal(true)" class="btn btn-secondary">Cancel</button>
        <button onclick="confirmTradeExecution()" class="btn btn-success">‚úì Execute Trade</button>
      </div>
    </div>
  </div>

  <script src="settings-manager.js"></script>
  <script src="migrate-settings.js"></script>
  <script src="settings-backup.js"></script>
  <script src="config.js"></script>
  <script src="symbol-input.js"></script>
  <script src="node-editor.js"></script>
  <script src="history-import.js"></script>
  <script src="overtrade-control.js"></script>
  <script src="volume-control.js"></script>
  <script src="resizable-panels.js"></script>
  <script src="node-plugin-manager.js"></script>
  <script src="renderer.js"></script>
</body>
</html>
